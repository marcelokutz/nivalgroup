var Selectize=function(t,e){var i,s,n,o;(o=t[0]).selectize=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);if(n=(n=r?r.getPropertyValue("direction"):o.currentStyle&&o.currentStyle.direction)||t.parents("[dir]:first").attr("dir")||"",$.extend(this,{order:0,settings:e,$input:t,tabIndex:t.attr("tabindex")||"",tagType:"select"===o.tagName.toLowerCase()?TAG_SELECT:TAG_INPUT,rtl:/rtl/i.test(n),eventNS:".selectize"+ ++Selectize.count,highlightedValue:null,isBlurring:!1,isOpen:!1,isDisabled:!1,isRequired:t.is("[required]"),isInvalid:!1,isLocked:!1,isFocused:!1,isInputHidden:!1,isSetup:!1,isShiftDown:!1,isCmdDown:!1,isCtrlDown:!1,ignoreFocus:!1,ignoreBlur:!1,ignoreHover:!1,hasOptions:!1,currentResults:null,lastValue:"",caretPos:0,loading:0,loadedSearches:{},$activeOption:null,$activeItems:[],optgroups:{},options:{},userOptions:{},items:[],renderCache:{},onSearchChange:null===e.loadThrottle?this.onSearchChange:debounce(this.onSearchChange,e.loadThrottle)}),this.sifter=new Sifter(this.options,{diacritics:e.diacritics}),this.settings.options){for(i=0,s=this.settings.options.length;i<s;i++)this.registerOption(this.settings.options[i]);delete this.settings.options}if(this.settings.optgroups){for(i=0,s=this.settings.optgroups.length;i<s;i++)this.registerOptionGroup(this.settings.optgroups[i]);delete this.settings.optgroups}this.settings.mode=this.settings.mode||(1===this.settings.maxItems?"single":"multi"),"boolean"!=typeof this.settings.hideSelected&&(this.settings.hideSelected="multi"===this.settings.mode),this.initializePlugins(this.settings.plugins),this.setupCallbacks(),this.setupTemplates(),this.setup()};MicroEvent.mixin(Selectize),"undefined"!=typeof MicroPlugin?MicroPlugin.mixin(Selectize):logError("Dependency MicroPlugin is missing",{explanation:'Make sure you either: (1) are using the "standalone" version of Selectize, or (2) require MicroPlugin before you load Selectize.'}),$.extend(Selectize.prototype,{setup:function(){var t,e,i,s,n,o,r,a,l,h,d=this,p=d.settings,c=d.eventNS,u=$(window),g=$(document),f=d.$input;if(r=d.settings.mode,a=f.attr("class")||"",t=$("<div>").addClass(p.wrapperClass).addClass(a).addClass(r),e=$("<div>").addClass(p.inputClass).addClass("items").appendTo(t),i=$('<input type="text" autocomplete="off" />').appendTo(e).attr("tabindex",f.is(":disabled")?"-1":d.tabIndex),o=$(p.dropdownParent||t),s=$("<div>").addClass(p.dropdownClass).addClass(r).hide().appendTo(o),n=$("<div>").addClass(p.dropdownContentClass).appendTo(s),(h=f.attr("id"))&&(i.attr("id",h+"-selectized"),$("label[for='"+h+"']").attr("for",h+"-selectized")),d.settings.copyClassesToDropdown&&s.addClass(a),t.css({width:f[0].style.width}),d.plugins.names.length&&(l="plugin-"+d.plugins.names.join(" plugin-"),t.addClass(l),s.addClass(l)),(null===p.maxItems||p.maxItems>1)&&d.tagType===TAG_SELECT&&f.attr("multiple","multiple"),d.settings.placeholder&&i.attr("placeholder",p.placeholder),!d.settings.splitOn&&d.settings.delimiter){var v=d.settings.delimiter.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");d.settings.splitOn=new RegExp("\\s*"+v+"+\\s*")}f.attr("autocorrect")&&i.attr("autocorrect",f.attr("autocorrect")),f.attr("autocapitalize")&&i.attr("autocapitalize",f.attr("autocapitalize")),i[0].type=f[0].type,d.$wrapper=t,d.$control=e,d.$control_input=i,d.$dropdown=s,d.$dropdown_content=n,s.on("mouseenter mousedown click","[data-disabled]>[data-selectable]",function(t){t.stopImmediatePropagation()}),s.on("mouseenter","[data-selectable]",function(){return d.onOptionHover.apply(d,arguments)}),s.on("mousedown click","[data-selectable]",function(){return d.onOptionSelect.apply(d,arguments)}),watchChildEvent(e,"mousedown","*:not(input)",function(){return d.onItemSelect.apply(d,arguments)}),autoGrow(i),e.on({mousedown:function(){return d.onMouseDown.apply(d,arguments)},click:function(){return d.onClick.apply(d,arguments)}}),i.on({mousedown:function(t){t.stopPropagation()},keydown:function(){return d.onKeyDown.apply(d,arguments)},keyup:function(){return d.onKeyUp.apply(d,arguments)},keypress:function(){return d.onKeyPress.apply(d,arguments)},resize:function(){d.positionDropdown.apply(d,[])},blur:function(){return d.onBlur.apply(d,arguments)},focus:function(){return d.ignoreBlur=!1,d.onFocus.apply(d,arguments)},paste:function(){return d.onPaste.apply(d,arguments)}}),g.on("keydown"+c,function(t){d.isCmdDown=t[IS_MAC?"metaKey":"ctrlKey"],d.isCtrlDown=t[IS_MAC?"altKey":"ctrlKey"],d.isShiftDown=t.shiftKey}),g.on("keyup"+c,function(t){t.keyCode===KEY_CTRL&&(d.isCtrlDown=!1),t.keyCode===KEY_SHIFT&&(d.isShiftDown=!1),t.keyCode===KEY_CMD&&(d.isCmdDown=!1)}),g.on("mousedown"+c,function(t){if(d.isFocused){if(t.target===d.$dropdown[0]||t.target.parentNode===d.$dropdown[0])return!1;d.$control.has(t.target).length||t.target===d.$control[0]||d.blur(t.target)}}),u.on(["scroll"+c,"resize"+c].join(" "),function(){d.isOpen&&d.positionDropdown.apply(d,arguments)}),u.on("mousemove"+c,function(){d.ignoreHover=!1}),this.revertSettings={$children:f.children().detach(),tabindex:f.attr("tabindex")},f.attr("tabindex",-1).hide().after(d.$wrapper),$.isArray(p.items)&&(d.setValue(p.items),delete p.items),SUPPORTS_VALIDITY_API&&f.on("invalid"+c,function(t){t.preventDefault(),d.isInvalid=!0,d.refreshState()}),d.updateOriginalInput(),d.refreshItems(),d.refreshState(),d.updatePlaceholder(),d.isSetup=!0,f.is(":disabled")&&d.disable(),d.on("change",this.onChange),f.data("selectize",d),f.addClass("selectized"),d.trigger("initialize"),!0===p.preload&&d.onSearchChange("")},setupTemplates:function(){var t=this.settings.labelField,e=this.settings.optgroupLabelField,i={optgroup:function(t){return'<div class="optgroup">'+t.html+"</div>"},optgroup_header:function(t,i){return'<div class="optgroup-header">'+i(t[e])+"</div>"},option:function(e,i){return'<div class="option">'+i(e[t])+"</div>"},item:function(e,i){return'<div class="item">'+i(e[t])+"</div>"},option_create:function(t,e){return'<div class="create">Add <strong>'+e(t.input)+"</strong>&hellip;</div>"}};this.settings.render=$.extend({},i,this.settings.render)},setupCallbacks:function(){var t,e,i={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(t in i)i.hasOwnProperty(t)&&(e=this.settings[i[t]])&&this.on(t,e)},onClick:function(t){this.isFocused&&this.isOpen||(this.focus(),t.preventDefault())},onMouseDown:function(t){var e=this,i=t.isDefaultPrevented();$(t.target);if(e.isFocused){if(t.target!==e.$control_input[0])return"single"===e.settings.mode?e.isOpen?e.close():e.open():i||e.setActiveItem(null),!1}else i||window.setTimeout(function(){e.focus()},0)},onChange:function(){this.$input.trigger("change")},onPaste:function(t){var e=this;e.isFull()||e.isInputHidden||e.isLocked?t.preventDefault():e.settings.splitOn&&setTimeout(function(){var t=e.$control_input.val();if(t.match(e.settings.splitOn))for(var i=$.trim(t).split(e.settings.splitOn),s=0,n=i.length;s<n;s++)e.createItem(i[s])},0)},onKeyPress:function(t){if(this.isLocked)return t&&t.preventDefault();var e=String.fromCharCode(t.keyCode||t.which);return this.settings.create&&"multi"===this.settings.mode&&e===this.settings.delimiter?(this.createItem(),t.preventDefault(),!1):void 0},onKeyDown:function(t){t.target,this.$control_input[0];if(this.isLocked)t.keyCode!==KEY_TAB&&t.preventDefault();else{switch(t.keyCode){case KEY_A:if(this.isCmdDown)return void this.selectAll();break;case KEY_ESC:return void(this.isOpen&&(t.preventDefault(),t.stopPropagation(),this.close()));case KEY_N:if(!t.ctrlKey||t.altKey)break;case KEY_DOWN:if(!this.isOpen&&this.hasOptions)this.open();else if(this.$activeOption){this.ignoreHover=!0;var e=this.getAdjacentOption(this.$activeOption,1);e.length&&this.setActiveOption(e,!0,!0)}return void t.preventDefault();case KEY_P:if(!t.ctrlKey||t.altKey)break;case KEY_UP:if(this.$activeOption){this.ignoreHover=!0;var i=this.getAdjacentOption(this.$activeOption,-1);i.length&&this.setActiveOption(i,!0,!0)}return void t.preventDefault();case KEY_RETURN:return void(this.isOpen&&this.$activeOption&&(this.onOptionSelect({currentTarget:this.$activeOption}),t.preventDefault()));case KEY_LEFT:return void this.advanceSelection(-1,t);case KEY_RIGHT:return void this.advanceSelection(1,t);case KEY_TAB:return this.settings.selectOnTab&&this.isOpen&&this.$activeOption&&(this.onOptionSelect({currentTarget:this.$activeOption}),this.isFull()||t.preventDefault()),void(this.settings.create&&this.createItem()&&t.preventDefault());case KEY_BACKSPACE:case KEY_DELETE:return void this.deleteSelection(t)}!this.isFull()&&!this.isInputHidden||(IS_MAC?t.metaKey:t.ctrlKey)||t.preventDefault()}},onKeyUp:function(t){if(this.isLocked)return t&&t.preventDefault();var e=this.$control_input.val()||"";this.lastValue!==e&&(this.lastValue=e,this.onSearchChange(e),this.refreshOptions(),this.trigger("type",e))},onSearchChange:function(t){var e=this,i=e.settings.load;i&&(e.loadedSearches.hasOwnProperty(t)||(e.loadedSearches[t]=!0,e.load(function(s){i.apply(e,[t,s])})))},onFocus:function(t){var e=this.isFocused;if(this.isDisabled)return this.blur(),t&&t.preventDefault(),!1;this.ignoreFocus||(this.isFocused=!0,"focus"===this.settings.preload&&this.onSearchChange(""),e||this.trigger("focus"),this.$activeItems.length||(this.showInput(),this.setActiveItem(null),this.refreshOptions(!!this.settings.openOnFocus)),this.refreshState())},onBlur:function(t,e){var i=this;if(i.isFocused&&(i.isFocused=!1,!i.ignoreFocus)){if(!i.ignoreBlur&&document.activeElement===i.$dropdown_content[0])return i.ignoreBlur=!0,void i.onFocus(t);var s=function(){i.close(),i.setTextboxValue(""),i.setActiveItem(null),i.setActiveOption(null),i.setCaret(i.items.length),i.refreshState(),e&&e.focus&&e.focus(),i.isBlurring=!1,i.ignoreFocus=!1,i.trigger("blur")};i.isBlurring=!0,i.ignoreFocus=!0,i.settings.create&&i.settings.createOnBlur?i.createItem(null,!1,s):s()}},onOptionHover:function(t){this.ignoreHover||this.setActiveOption(t.currentTarget,!1)},onOptionSelect:function(t){var e,i,s=this;t.preventDefault&&(t.preventDefault(),t.stopPropagation()),(i=$(t.currentTarget)).hasClass("create")?s.createItem(null,function(){s.settings.closeAfterSelect&&s.close()}):void 0!==(e=i.attr("data-value"))&&(s.lastQuery=null,s.setTextboxValue(""),s.addItem(e),s.settings.closeAfterSelect?s.close():!s.settings.hideSelected&&t.type&&/mouse/.test(t.type)&&s.setActiveOption(s.getOption(e)))},onItemSelect:function(t){this.isLocked||"multi"===this.settings.mode&&(t.preventDefault(),this.setActiveItem(t.currentTarget,t))},load:function(t){var e=this,i=e.$wrapper.addClass(e.settings.loadingClass);e.loading++,t.apply(e,[function(t){e.loading=Math.max(e.loading-1,0),t&&t.length&&(e.addOption(t),e.refreshOptions(e.isFocused&&!e.isInputHidden)),e.loading||i.removeClass(e.settings.loadingClass),e.trigger("load",t)}])},setTextboxValue:function(t){var e=this.$control_input;e.val()!==t&&(e.val(t).triggerHandler("update"),this.lastValue=t)},getValue:function(){return this.tagType===TAG_SELECT&&this.$input.attr("multiple")?this.items:this.items.join(this.settings.delimiter)},setValue:function(t,e){debounce_events(this,e?[]:["change"],function(){this.clear(e),this.addItems(t,e)})},setActiveItem:function(t,e){var i,s,n,o,r,a,l,h;if("single"!==this.settings.mode){if(!(t=$(t)).length)return $(this.$activeItems).removeClass("active"),this.$activeItems=[],void(this.isFocused&&this.showInput());if("mousedown"===(i=e&&e.type.toLowerCase())&&this.isShiftDown&&this.$activeItems.length){for(h=this.$control.children(".active:last"),(o=Array.prototype.indexOf.apply(this.$control[0].childNodes,[h[0]]))>(r=Array.prototype.indexOf.apply(this.$control[0].childNodes,[t[0]]))&&(l=o,o=r,r=l),s=o;s<=r;s++)a=this.$control[0].childNodes[s],-1===this.$activeItems.indexOf(a)&&($(a).addClass("active"),this.$activeItems.push(a));e.preventDefault()}else"mousedown"===i&&this.isCtrlDown||"keydown"===i&&this.isShiftDown?t.hasClass("active")?(n=this.$activeItems.indexOf(t[0]),this.$activeItems.splice(n,1),t.removeClass("active")):this.$activeItems.push(t.addClass("active")[0]):($(this.$activeItems).removeClass("active"),this.$activeItems=[t.addClass("active")[0]]);this.hideInput(),this.isFocused||this.focus()}},setActiveOption:function(t,e,i){var s,n,o,r,a;this.$activeOption&&this.$activeOption.removeClass("active"),this.$activeOption=null,(t=$(t)).length&&(this.$activeOption=t.addClass("active"),!e&&isset(e)||(s=this.$dropdown_content.height(),n=this.$activeOption.outerHeight(!0),e=this.$dropdown_content.scrollTop()||0,r=o=this.$activeOption.offset().top-this.$dropdown_content.offset().top+e,a=o-s+n,o+n>s+e?this.$dropdown_content.stop().animate({scrollTop:a},i?this.settings.scrollDuration:0):o<e&&this.$dropdown_content.stop().animate({scrollTop:r},i?this.settings.scrollDuration:0)))},selectAll:function(){"single"!==this.settings.mode&&(this.$activeItems=Array.prototype.slice.apply(this.$control.children(":not(input)").addClass("active")),this.$activeItems.length&&(this.hideInput(),this.close()),this.focus())},hideInput:function(){this.setTextboxValue(""),this.$control_input.css({opacity:0,position:"absolute",left:this.rtl?1e4:-1e4}),this.isInputHidden=!0},showInput:function(){this.$control_input.css({opacity:1,position:"relative",left:0}),this.isInputHidden=!1},focus:function(){var t=this;t.isDisabled||(t.ignoreFocus=!0,t.$control_input[0].focus(),window.setTimeout(function(){t.ignoreFocus=!1,t.onFocus()},0))},blur:function(t){this.$control_input[0].blur(),this.onBlur(null,t)},getScoreFunction:function(t){return this.sifter.getScoreFunction(t,this.getSearchOptions())},getSearchOptions:function(){var t=this.settings,e=t.sortField;return"string"==typeof e&&(e=[{field:e}]),{fields:t.searchField,conjunction:t.searchConjunction,sort:e,nesting:t.nesting}},search:function(t){var e,i,s,n=this.settings,o=this.getSearchOptions();if(n.score&&"function"!=typeof(s=this.settings.score.apply(this,[t])))throw new Error('Selectize "score" setting must be a function that returns a function');if(t!==this.lastQuery?(this.lastQuery=t,i=this.sifter.search(t,$.extend(o,{score:s})),this.currentResults=i):i=$.extend(!0,{},this.currentResults),n.hideSelected)for(e=i.items.length-1;e>=0;e--)-1!==this.items.indexOf(hash_key(i.items[e].id))&&i.items.splice(e,1);return i},refreshOptions:function(t){var e,i,s,n,o,r,a,l,h,d,p,c,u,g,f,v;void 0===t&&(t=!0);var m=this,O=$.trim(m.$control_input.val()),C=m.search(O),y=m.$dropdown_content,w=m.$activeOption&&hash_key(m.$activeOption.attr("data-value"));for(n=C.items.length,"number"==typeof m.settings.maxOptions&&(n=Math.min(n,m.settings.maxOptions)),o={},r=[],e=0;e<n;e++)for(a=m.options[C.items[e].id],l=m.render("option",a),h=a[m.settings.optgroupField]||"",i=0,s=(d=$.isArray(h)?h:[h])&&d.length;i<s;i++)h=d[i],m.optgroups.hasOwnProperty(h)||(h=""),o.hasOwnProperty(h)||(o[h]=document.createDocumentFragment(),r.push(h)),o[h].appendChild(l);for(this.settings.lockOptgroupOrder&&r.sort(function(t,e){return(m.optgroups[t].$order||0)-(m.optgroups[e].$order||0)}),p=document.createDocumentFragment(),e=0,n=r.length;e<n;e++)h=r[e],m.optgroups.hasOwnProperty(h)&&o[h].childNodes.length?((c=document.createDocumentFragment()).appendChild(m.render("optgroup_header",m.optgroups[h])),c.appendChild(o[h]),p.appendChild(m.render("optgroup",$.extend({},m.optgroups[h],{html:domToString(c),dom:c})))):p.appendChild(o[h]);if(y.html(p),m.settings.highlight&&(y.removeHighlight(),C.query.length&&C.tokens.length))for(e=0,n=C.tokens.length;e<n;e++)highlight(y,C.tokens[e].regex);if(!m.settings.hideSelected)for(e=0,n=m.items.length;e<n;e++)m.getOption(m.items[e]).addClass("selected");(u=m.canCreate(O))&&(y.prepend(m.render("option_create",{input:O})),v=$(y[0].childNodes[0])),m.hasOptions=C.items.length>0||u,m.hasOptions?(C.items.length>0?((f=w&&m.getOption(w))&&f.length?g=f:"single"===m.settings.mode&&m.items.length&&(g=m.getOption(m.items[0])),g&&g.length||(g=v&&!m.settings.addPrecedence?m.getAdjacentOption(v,1):y.find("[data-selectable]:first"))):g=v,m.setActiveOption(g),t&&!m.isOpen&&m.open()):(m.setActiveOption(null),t&&m.isOpen&&m.close())},addOption:function(t){var e,i,s;if($.isArray(t))for(e=0,i=t.length;e<i;e++)this.addOption(t[e]);else(s=this.registerOption(t))&&(this.userOptions[s]=!0,this.lastQuery=null,this.trigger("option_add",s,t))},registerOption:function(t){var e=hash_key(t[this.settings.valueField]);return void 0!==e&&null!==e&&!this.options.hasOwnProperty(e)&&(t.$order=t.$order||++this.order,this.options[e]=t,e)},registerOptionGroup:function(t){var e=hash_key(t[this.settings.optgroupValueField]);return!!e&&(t.$order=t.$order||++this.order,this.optgroups[e]=t,e)},addOptionGroup:function(t,e){e[this.settings.optgroupValueField]=t,(t=this.registerOptionGroup(e))&&this.trigger("optgroup_add",t,e)},removeOptionGroup:function(t){this.optgroups.hasOwnProperty(t)&&(delete this.optgroups[t],this.renderCache={},this.trigger("optgroup_remove",t))},clearOptionGroups:function(){this.optgroups={},this.renderCache={},this.trigger("optgroup_clear")},updateOption:function(t,e){var i,s,n,o,r,a,l;if(t=hash_key(t),n=hash_key(e[this.settings.valueField]),null!==t&&this.options.hasOwnProperty(t)){if("string"!=typeof n)throw new Error("Value must be set in option data");l=this.options[t].$order,n!==t&&(delete this.options[t],-1!==(o=this.items.indexOf(t))&&this.items.splice(o,1,n)),e.$order=e.$order||l,this.options[n]=e,r=this.renderCache.item,a=this.renderCache.option,r&&(delete r[t],delete r[n]),a&&(delete a[t],delete a[n]),-1!==this.items.indexOf(n)&&(i=this.getItem(t),s=$(this.render("item",e)),i.hasClass("active")&&s.addClass("active"),i.replaceWith(s)),this.lastQuery=null,this.isOpen&&this.refreshOptions(!1)}},removeOption:function(t,e){t=hash_key(t);var i=this.renderCache.item,s=this.renderCache.option;i&&delete i[t],s&&delete s[t],delete this.userOptions[t],delete this.options[t],this.lastQuery=null,this.trigger("option_remove",t),this.removeItem(t,e)},clearOptions:function(){var t=this;t.loadedSearches={},t.userOptions={},t.renderCache={};var e=t.options;$.each(t.options,function(i,s){-1==t.items.indexOf(i)&&delete e[i]}),t.options=t.sifter.items=e,t.lastQuery=null,t.trigger("option_clear")},getOption:function(t){return this.getElementWithValue(t,this.$dropdown_content.find("[data-selectable]"))},getAdjacentOption:function(t,e){var i=this.$dropdown.find("[data-selectable]"),s=i.index(t)+e;return s>=0&&s<i.length?i.eq(s):$()},getElementWithValue:function(t,e){if(void 0!==(t=hash_key(t))&&null!==t)for(var i=0,s=e.length;i<s;i++)if(e[i].getAttribute("data-value")===t)return $(e[i]);return $()},getItem:function(t){return this.getElementWithValue(t,this.$control.children())},addItems:function(t,e){this.buffer=document.createDocumentFragment();for(var i=this.$control[0].childNodes,s=0;s<i.length;s++)this.buffer.appendChild(i[s]);for(var n=$.isArray(t)?t:[t],o=(s=0,n.length);s<o;s++)this.isPending=s<o-1,this.addItem(n[s],e);var r=this.$control[0];r.insertBefore(this.buffer,r.firstChild),this.buffer=null},addItem:function(t,e){debounce_events(this,e?[]:["change"],function(){var i,s,n,o,r,a=this.settings.mode;t=hash_key(t),-1===this.items.indexOf(t)?this.options.hasOwnProperty(t)&&("single"===a&&this.clear(e),"multi"===a&&this.isFull()||(i=$(this.render("item",this.options[t])),r=this.isFull(),this.items.splice(this.caretPos,0,t),this.insertAtCaret(i),(!this.isPending||!r&&this.isFull())&&this.refreshState(),this.isSetup&&(n=this.$dropdown_content.find("[data-selectable]"),this.isPending||(s=this.getOption(t),o=this.getAdjacentOption(s,1).attr("data-value"),this.refreshOptions(this.isFocused&&"single"!==a),o&&this.setActiveOption(this.getOption(o))),!n.length||this.isFull()?this.close():this.isPending||this.positionDropdown(),this.updatePlaceholder(),this.trigger("item_add",t,i),this.isPending||this.updateOriginalInput({silent:e})))):"single"===a&&this.close()})},removeItem:function(t,e){var i,s,n;i=t instanceof $?t:this.getItem(t),t=hash_key(i.attr("data-value")),-1!==(s=this.items.indexOf(t))&&(i.remove(),i.hasClass("active")&&(n=this.$activeItems.indexOf(i[0]),this.$activeItems.splice(n,1)),this.items.splice(s,1),this.lastQuery=null,!this.settings.persist&&this.userOptions.hasOwnProperty(t)&&this.removeOption(t,e),s<this.caretPos&&this.setCaret(this.caretPos-1),this.refreshState(),this.updatePlaceholder(),this.updateOriginalInput({silent:e}),this.positionDropdown(),this.trigger("item_remove",t,i))},createItem:function(t,e){var i=this,s=i.caretPos;t=t||$.trim(i.$control_input.val()||"");var n=arguments[arguments.length-1];if("function"!=typeof n&&(n=function(){}),"boolean"!=typeof e&&(e=!0),!i.canCreate(t))return n(),!1;i.lock();var o="function"==typeof i.settings.create?this.settings.create:function(t){var e={};return e[i.settings.labelField]=t,e[i.settings.valueField]=t,e},r=once(function(t){if(i.unlock(),!t||"object"!=typeof t)return n();var o=hash_key(t[i.settings.valueField]);if("string"!=typeof o)return n();i.setTextboxValue(""),i.addOption(t),i.setCaret(s),i.addItem(o),i.refreshOptions(e&&"single"!==i.settings.mode),n(t)}),a=o.apply(this,[t,r]);return void 0!==a&&r(a),!0},refreshItems:function(){this.lastQuery=null,this.isSetup&&this.addItem(this.items),this.refreshState(),this.updateOriginalInput()},refreshState:function(){this.refreshValidityState(),this.refreshClasses()},refreshValidityState:function(){if(!this.isRequired)return!1;var t=!this.items.length;this.isInvalid=t,this.$control_input.prop("required",t),this.$input.prop("required",!t)},refreshClasses:function(){var t=this.isFull(),e=this.isLocked;this.$wrapper.toggleClass("rtl",this.rtl),this.$control.toggleClass("focus",this.isFocused).toggleClass("disabled",this.isDisabled).toggleClass("required",this.isRequired).toggleClass("invalid",this.isInvalid).toggleClass("locked",e).toggleClass("full",t).toggleClass("not-full",!t).toggleClass("input-active",this.isFocused&&!this.isInputHidden).toggleClass("dropdown-active",this.isOpen).toggleClass("has-options",!$.isEmptyObject(this.options)).toggleClass("has-items",this.items.length>0),this.$control_input.data("grow",!t&&!e)},isFull:function(){return null!==this.settings.maxItems&&this.items.length>=this.settings.maxItems},updateOriginalInput:function(t){var e,i,s,n;if(t=t||{},this.tagType===TAG_SELECT){for(s=[],e=0,i=this.items.length;e<i;e++)n=this.options[this.items[e]][this.settings.labelField]||"",s.push('<option value="'+escape_html(this.items[e])+'" selected="selected">'+escape_html(n)+"</option>");s.length||this.$input.attr("multiple")||s.push('<option value="" selected="selected"></option>'),this.$input.html(s.join(""))}else this.$input.val(this.getValue()),this.$input.attr("value",this.$input.val());this.isSetup&&(t.silent||this.trigger("change",this.$input.val()))},updatePlaceholder:function(){if(this.settings.placeholder){var t=this.$control_input;this.items.length?t.removeAttr("placeholder"):t.attr("placeholder",this.settings.placeholder),t.triggerHandler("update",{force:!0})}},open:function(){this.isLocked||this.isOpen||"multi"===this.settings.mode&&this.isFull()||(this.focus(),this.isOpen=!0,this.refreshState(),this.$dropdown.css({visibility:"hidden",display:"block"}),this.positionDropdown(),this.$dropdown.css({visibility:"visible"}),this.trigger("dropdown_open",this.$dropdown))},close:function(){var t=this.isOpen;"single"===this.settings.mode&&this.items.length&&(this.hideInput(),this.isBlurring||this.$control_input.blur()),this.isOpen=!1,this.$dropdown.hide(),this.setActiveOption(null),this.refreshState(),t&&this.trigger("dropdown_close",this.$dropdown)},positionDropdown:function(){var t=this.$control,e="body"===this.settings.dropdownParent?t.offset():t.position();e.top+=t.outerHeight(!0),this.$dropdown.css({width:t[0].getBoundingClientRect().width,top:e.top,left:e.left})},clear:function(t){this.items.length&&(this.$control.children(":not(input)").remove(),this.items=[],this.lastQuery=null,this.setCaret(0),this.setActiveItem(null),this.updatePlaceholder(),this.updateOriginalInput({silent:t}),this.refreshState(),this.showInput(),this.trigger("clear"))},insertAtCaret:function(t){var e=Math.min(this.caretPos,this.items.length),i=t[0],s=this.buffer||this.$control[0];0===e?s.insertBefore(i,s.firstChild):s.insertBefore(i,s.childNodes[e]),this.setCaret(e+1)},deleteSelection:function(t){var e,i,s,n,o,r,a,l,h;if(s=t&&t.keyCode===KEY_BACKSPACE?-1:1,n=getSelection(this.$control_input[0]),this.$activeOption&&!this.settings.hideSelected&&(a=this.getAdjacentOption(this.$activeOption,-1).attr("data-value")),o=[],this.$activeItems.length){for(h=this.$control.children(".active:"+(s>0?"last":"first")),r=this.$control.children(":not(input)").index(h),s>0&&r++,e=0,i=this.$activeItems.length;e<i;e++)o.push($(this.$activeItems[e]).attr("data-value"));t&&(t.preventDefault(),t.stopPropagation())}else(this.isFocused||"single"===this.settings.mode)&&this.items.length&&(s<0&&0===n.start&&0===n.length?o.push(this.items[this.caretPos-1]):s>0&&n.start===this.$control_input.val().length&&o.push(this.items[this.caretPos]));if(!o.length||"function"==typeof this.settings.onDelete&&!1===this.settings.onDelete.apply(this,[o]))return!1;for(void 0!==r&&this.setCaret(r);o.length;)this.removeItem(o.pop());return this.showInput(),this.positionDropdown(),this.refreshOptions(!0),a&&(l=this.getOption(a)).length&&this.setActiveOption(l),!0},advanceSelection:function(t,e){var i,s,n,o,r;0!==t&&(this.rtl&&(t*=-1),i=t>0?"last":"first",s=getSelection(this.$control_input[0]),this.isFocused&&!this.isInputHidden?(o=this.$control_input.val().length,(t<0?0===s.start&&0===s.length:s.start===o)&&!o&&this.advanceCaret(t,e)):(r=this.$control.children(".active:"+i)).length&&(n=this.$control.children(":not(input)").index(r),this.setActiveItem(null),this.setCaret(t>0?n+1:n)))},advanceCaret:function(t,e){var i,s;0!==t&&(i=t>0?"next":"prev",this.isShiftDown?(s=this.$control_input[i]()).length&&(this.hideInput(),this.setActiveItem(s),e&&e.preventDefault()):this.setCaret(this.caretPos+t))},setCaret:function(t){var e,i,s,n;if(t="single"===this.settings.mode?this.items.length:Math.max(0,Math.min(this.items.length,t)),!this.isPending)for(e=0,i=(s=this.$control.children(":not(input)")).length;e<i;e++)n=$(s[e]).detach(),e<t?this.$control_input.before(n):this.$control.append(n);this.caretPos=t},lock:function(){this.close(),this.isLocked=!0,this.refreshState()},unlock:function(){this.isLocked=!1,this.refreshState()},disable:function(){this.$input.prop("disabled",!0),this.$control_input.prop("disabled",!0).prop("tabindex",-1),this.isDisabled=!0,this.lock()},enable:function(){this.$input.prop("disabled",!1),this.$control_input.prop("disabled",!1).prop("tabindex",this.tabIndex),this.isDisabled=!1,this.unlock()},destroy:function(){var t=this.eventNS,e=this.revertSettings;this.trigger("destroy"),this.off(),this.$wrapper.remove(),this.$dropdown.remove(),this.$input.html("").append(e.$children).removeAttr("tabindex").removeClass("selectized").attr({tabindex:e.tabindex}).show(),this.$control_input.removeData("grow"),this.$input.removeData("selectize"),0==--Selectize.count&&Selectize.$testInput&&(Selectize.$testInput.remove(),Selectize.$testInput=void 0),$(window).off(t),$(document).off(t),$(document.body).off(t),delete this.$input[0].selectize},render:function(t,e){var i,s,n="",o=!1;return"option"!==t&&"item"!==t||(o=!!(i=hash_key(e[this.settings.valueField]))),o&&(isset(this.renderCache[t])||(this.renderCache[t]={}),this.renderCache[t].hasOwnProperty(i))?this.renderCache[t][i]:(n=$(this.settings.render[t].apply(this,[e,escape_html])),"option"===t||"option_create"===t?e[this.settings.disabledField]||n.attr("data-selectable",""):"optgroup"===t&&(s=e[this.settings.optgroupValueField]||"",n.attr("data-group",s),e[this.settings.disabledField]&&n.attr("data-disabled","")),"option"!==t&&"item"!==t||n.attr("data-value",i||""),o&&(this.renderCache[t][i]=n[0]),n[0])},clearCache:function(t){void 0===t?this.renderCache={}:delete this.renderCache[t]},canCreate:function(t){if(!this.settings.create)return!1;var e=this.settings.createFilter;return t.length&&("function"!=typeof e||e.apply(this,[t]))&&("string"!=typeof e||new RegExp(e).test(t))&&(!(e instanceof RegExp)||e.test(t))}});